name: Daily Trello Backup

on:
  workflow_dispatch:

jobs:
  download-and-commit:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout del código
        uses: actions/checkout@v4

      - name: Crear carpetas necesarias
        run: |
          mkdir -p data_trello
          mkdir -p Portadas

      - name: Descargar JSON Trello
        id: download_json
        env:
          TRELLO_KEY: ${{ secrets.TRELLO_KEY }}
          TRELLO_TOKEN: ${{ secrets.TRELLO_TOKEN }}
        run: |
          # Fecha correcta para Venezuela
          DATE=$(TZ='America/Caracas' date +'%Y-%m-%d')
          
          # Guardamos el nombre del archivo en una variable de entorno para usarla en el siguiente paso
          FILENAME="data_trello/${DATE} trello.json"
          echo "JSON_FILE=$FILENAME" >> $GITHUB_ENV
          
          # Descarga del JSON completo
          curl -L "https://api.trello.com/1/boards/3llFrI1o?key=$TRELLO_KEY&token=$TRELLO_TOKEN&labels=all&cards=all&lists=all&checklists=all&actions=all&actions_limit=1000&fields=all&customFields=true&card_pluginData=true&pluginData=true&card_attachments=true&members=all&organization=true" -o "$FILENAME"
          
          echo "Archivo JSON descargado: $FILENAME"

      - name: Procesar y Descargar Portadas
        env:
          TRELLO_KEY: ${{ secrets.TRELLO_KEY }}
          TRELLO_TOKEN: ${{ secrets.TRELLO_TOKEN }}
        run: |
          echo "Procesando imágenes desde: ${{ env.JSON_FILE }}"
          
          # 1. Usamos jq para extraer ID y URL solo de las cartas que tienen portada.
          # La lógica es: Buscar cartas con idAttachmentCover != null -> Encontrar el adjunto que coincide con ese ID -> Imprimir "ID URL"
          
          jq -r '.cards[] | select(.idAttachmentCover != null) | .id as $id | .idAttachmentCover as $cover | .attachments[] | select(.id == $cover) | "\($id) \(.url)"' "${{ env.JSON_FILE }}" > covers_to_download.txt
          
          # 2. Leemos el archivo generado y descargamos imagen por imagen
          count=0
          while read -r card_id url; do
            # Definir nombre de archivo según lo que espera tu HTML (ID.png)
            filepath="Portadas/${card_id}.png"
            
            # Descargamos la imagen.
            # IMPORTANTE: Agregamos key y token a la URL de la imagen por si el tablero es privado.
            # Usamos -s (silent) para no llenar el log, pero mostramos errores.
            curl -s -L -o "$filepath" "${url}?key=${TRELLO_KEY}&token=${TRELLO_TOKEN}"
            
            ((count++))
          done < covers_to_download.txt
          
          echo "✅ Se han descargado/actualizado $count portadas en la carpeta Portadas/"
          rm covers_to_download.txt

      - name: Guardar cambios en Git
        run: |
          git config --global user.name "GitHub Actions Bot"
          git config --global user.email "actions@github.com"
          
          # Agregamos tanto el JSON como las imágenes nuevas
          git add data_trello/
          git add Portadas/
          
          if git diff --staged --quiet; then
            echo "No hay cambios nuevos."
          else
            COMMIT_DATE=$(TZ='America/Caracas' date +'%Y-%m-%d')
            git commit -m "Backup y Portadas: $COMMIT_DATE"
            
            git pull --rebase
            git push
          fi

      - name: Notificar a Telegram
        if: always()
        env:
          TELEGRAM_TOKEN: ${{ secrets.TELEGRAM_TOKEN }}
          TELEGRAM_TO: ${{ secrets.TELEGRAM_TO }}
          JOB_STATUS: ${{ job.status }}
        run: |
          if [ "$JOB_STATUS" == "success" ]; then
            MESSAGE="✅ Backup de Trello + Imágenes completado."
          else
            MESSAGE="❌ ALERTA: Falló el backup de Trello/Imágenes."
          fi
          
          curl -s -X POST "https://api.telegram.org/bot$TELEGRAM_TOKEN/sendMessage" \
          -d chat_id="$TELEGRAM_TO" \
          -d text="$MESSAGE"
